<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario de Consulta</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            background-color: #f4f6f9;
        }
        .form-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #resultados {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
        }
        table {
            background: white;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h3 class="mb-4">üîç Consulta de Postulaciones</h3>
        <div class="mb-3">
            <label for="fileInput" class="form-label">Cargar archivo Excel</label>
            <input type="file" id="fileInput" class="form-control" accept=".xlsx, .xls">
        </div>
        <div class="mb-3">
            <label for="cedulaInput" class="form-label">Ingrese C√©dula</label>
            <input type="text" id="cedulaInput" class="form-control">
        </div>
        <button class="btn btn-primary" onclick="buscarCedula()">Buscar</button>

        <div id="resultados"></div>
        <div id="exportButtons" class="mt-3" style="display:none;">
            <button class="btn btn-success me-2" onclick="exportarExcel()">üìÇ Exportar a Excel</button>
            <button class="btn btn-danger" onclick="exportarPDF()">üìÑ Exportar a PDF</button>
        </div>
    </div>

    <script>
        let datosExcel = [];
        let resultadosActuales = [];

        document.getElementById("fileInput").addEventListener("change", function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                datosExcel = XLSX.utils.sheet_to_json(sheet);
                alert("‚úÖ Archivo cargado correctamente.");
            };
            reader.readAsArrayBuffer(file);
        });

        function buscarCedula() {
            const cedula = document.getElementById("cedulaInput").value.trim();
            const resultadosDiv = document.getElementById("resultados");
            resultadosDiv.innerHTML = "";
            resultadosActuales = [];

            if (!cedula) {
                resultadosDiv.innerHTML = "<p class='text-danger'>‚ö†Ô∏è Por favor ingrese una c√©dula.</p>";
                return;
            }

            if (!datosExcel.length) {
                resultadosDiv.innerHTML = "<p class='text-danger'>‚ö†Ô∏è Primero cargue un archivo Excel.</p>";
                return;
            }

            const columnas = Object.keys(datosExcel[0]);
            const columnaCedula = columnas.find(c => c.toLowerCase().includes("cedul"));

            if (!columnaCedula) {
                resultadosDiv.innerHTML = "<p class='text-danger'>‚ùå No se encontr√≥ ninguna columna de C√©dula en el archivo.</p>";
                return;
            }

            const encontrados = datosExcel.filter(fila => fila[columnaCedula] == cedula);

            if (encontrados.length > 0) {
                resultadosActuales = encontrados;

                let html = `<p><strong>Se encontraron ${encontrados.length} registros</strong></p>`;
                html += `<table class="table table-bordered"><thead><tr>`;
                Object.keys(encontrados[0]).forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += `</tr></thead><tbody>`;

                encontrados.forEach(fila => {
                    html += `<tr>`;
                    Object.values(fila).forEach(valor => {
                        html += `<td>${valor}</td>`;
                    });
                    html += `</tr>`;
                });

                html += `</tbody></table>`;
                resultadosDiv.innerHTML = html;

                document.getElementById("exportButtons").style.display = "block";
            } else {
                resultadosDiv.innerHTML = "<p class='text-danger'>‚ùå No se encontraron registros para esta c√©dula.</p>";
                document.getElementById("exportButtons").style.display = "none";
            }
        }

        function exportarExcel() {
            if (!resultadosActuales.length) return;
            const ws = XLSX.utils.json_to_sheet(resultadosActuales);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Resultados");
            XLSX.writeFile(wb, "consulta_resultados.xlsx");
        }

        function exportarPDF() {
            if (!resultadosActuales.length) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Resultados de la Consulta", 14, 15);
            doc.autoTable({
                startY: 25,
                head: [Object.keys(resultadosActuales[0])],
                body: resultadosActuales.map(fila => Object.values(fila))
            });
            doc.save("consulta_resultados.pdf");
        }
    </script>
</body>
</html>
